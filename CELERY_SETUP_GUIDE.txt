CELERY MESSAGE QUEUE SETUP GUIDE
==================================

WHAT CHANGED:
=============

Old System (Threading):
  - Used Python threads for background notifications
  - Not reliable (might lose messages if server restarts)
  - No retry mechanism
  - No guarantee of delivery

New System (Celery Queue):
  - Messages stored in Redis queue
  - Processed one by one per user
  - Automatic retries (3 attempts)
  - Messages persist even if server restarts
  - Independent worker process
  - Guaranteed delivery


HOW IT WORKS:
=============

1. User completes payment or admin confirms booking
2. Response sent immediately to user (<200ms)
3. Message added to Redis queue
4. Celery worker picks up message from queue
5. Worker processes message (sends SMS, WhatsApp, Email)
6. If fails, automatically retries (3 times with backoff)
7. Next message processed


SETUP INSTRUCTIONS:
===================

Step 1: Install Redis (if not already running)
-----------------------------------------------

Windows:
1. Download Redis from: https://github.com/microsoftarchive/redis/releases
2. Install Redis
3. Start Redis: redis-server

Or using Docker:
docker run -d -p 6379:6379 redis:latest

Or using WSL:
sudo apt-get install redis-server
redis-server


Step 2: Verify Redis is Running
--------------------------------

Test connection:
redis-cli ping

Expected output: PONG


Step 3: Configure Redis URL (if needed)
----------------------------------------

Add to your .env file:
REDIS_URL=redis://localhost:6379/0

Or for remote Redis:
REDIS_URL=redis://username:password@host:port/db


Step 4: Start Celery Worker
----------------------------

Open a NEW terminal window and run:

python start_celery_worker.py

Or manually:
celery -A app.celery_config.celery_app worker --loglevel=info --pool=solo -Q notifications --concurrency=1

Keep this terminal open - this is your message processor!


Step 5: Start Your FastAPI Application
---------------------------------------

In your main terminal:
python run.py

Or:
uvicorn app.main:app --reload


Step 6: Test the System
------------------------

1. Create a booking with payment
2. Verify payment
3. Check response is immediate (<200ms)
4. Watch Celery worker terminal - you'll see message processing
5. User receives notification (SMS, WhatsApp, Email)


VERIFICATION:
=============

Check if everything is working:

1. Redis Running:
   redis-cli ping
   Should return: PONG

2. Celery Worker Running:
   Check terminal for:
   "celery@notification_worker ready"

3. Queue Status:
   redis-cli
   > LLEN celery
   > KEYS *

4. Test Message:
   python -c "from app.tasks import test_celery; test_celery.delay()"
   Check worker terminal for success message


MONITORING:
===========

View Queue Size:
redis-cli LLEN celery

View Active Tasks:
celery -A app.celery_config.celery_app inspect active

View Registered Tasks:
celery -A app.celery_config.celery_app inspect registered

View Worker Stats:
celery -A app.celery_config.celery_app inspect stats


PRODUCTION DEPLOYMENT:
======================

For Production, you need:

1. Redis Server (managed service recommended):
   - AWS ElastiCache
   - Redis Cloud
   - DigitalOcean Managed Redis

2. Celery Worker (run as service):
   
   Linux (systemd):
   Create /etc/systemd/system/celery-worker.service:
   
   [Unit]
   Description=Celery Worker for Booking Notifications
   After=network.target redis.service
   
   [Service]
   Type=forking
   User=www-data
   Group=www-data
   WorkingDirectory=/path/to/your/app
   Environment="PATH=/path/to/venv/bin"
   ExecStart=/path/to/venv/bin/celery -A app.celery_config.celery_app worker --loglevel=info -Q notifications --concurrency=1
   Restart=always
   
   [Install]
   WantedBy=multi-user.target
   
   Then:
   sudo systemctl daemon-reload
   sudo systemctl enable celery-worker
   sudo systemctl start celery-worker

   Windows (NSSM):
   1. Download NSSM: https://nssm.cc/download
   2. Install service:
      nssm install CeleryWorker "C:\path\to\python.exe" "C:\path\to\start_celery_worker.py"
   3. Start service:
      nssm start CeleryWorker

3. Monitor with Flower (optional):
   pip install flower
   celery -A app.celery_config.celery_app flower
   Open http://localhost:5555


TROUBLESHOOTING:
================

Problem: Worker not starting
Solution:
  - Check Redis is running: redis-cli ping
  - Check Celery is installed: pip install celery redis
  - Check Python path is correct
  - Try: celery -A app.celery_config.celery_app worker --loglevel=debug

Problem: Messages not being processed
Solution:
  - Check worker is running
  - Check queue has messages: redis-cli LLEN celery
  - Check worker logs for errors
  - Restart worker

Problem: Notifications not sending
Solution:
  - Check NotificationService configuration
  - Check SMS/WhatsApp/Email credentials
  - Check worker logs for specific errors
  - Try manual notification test

Problem: Redis connection error
Solution:
  - Check REDIS_URL in config
  - Check Redis is running on correct port
  - Check firewall/network settings
  - Try: redis-cli -h localhost -p 6379 ping


MESSAGE FLOW:
=============

[User] -> [API: verify-payment]
               |
               v
        [Save to Database]
               |
               v
        [Update Booking Status]
               |
               v
        [Queue Message to Redis] <-- INSTANT RESPONSE HERE
               |
               v
        [Return Response to User]


Meanwhile, independently:

[Redis Queue]
      |
      v
[Celery Worker Picks Message]
      |
      v
[Send SMS/WhatsApp/Email]
      |
      v
[Retry if Failed (3 times)]
      |
      v
[Mark Complete or Failed]


ADVANTAGES OVER THREADING:
==========================

1. Reliability:
   - Messages persist in Redis
   - Survive server restarts
   - Guaranteed processing

2. Retry Logic:
   - Automatic retries (3 times)
   - Exponential backoff
   - Jitter to prevent thundering herd

3. Monitoring:
   - See queue size
   - Track active tasks
   - View worker status
   - Monitor with Flower

4. Scalability:
   - Add more workers easily
   - Horizontal scaling
   - Load balancing

5. Independence:
   - Worker separate from web server
   - Can restart independently
   - Better resource management


PERFORMANCE:
============

Response Time:
  - verify-payment: <200ms (unchanged)
  - Queue message: <10ms (Redis write)
  - Total: <200ms to user

Message Processing:
  - Worker processes one message at a time
  - Average: 2-5 seconds per message
  - Retry delays: 60s, 120s, 240s (exponential)

Queue Capacity:
  - Redis can hold millions of messages
  - Memory: ~1KB per message
  - Throughput: 100,000+ messages/second


CONFIGURATION OPTIONS:
======================

In app/celery_config.py, you can adjust:

task_time_limit: Maximum task execution time (default: 300s)
task_soft_time_limit: Soft limit before hard kill (default: 240s)
worker_prefetch_multiplier: Messages to prefetch (default: 1)
task_acks_late: Acknowledge after completion (default: True)

In app/tasks.py, you can adjust:

max_retries: Number of retry attempts (default: 3)
default_retry_delay: Delay between retries (default: 60s)
retry_backoff: Use exponential backoff (default: True)
retry_jitter: Add random jitter (default: True)


FILES CREATED:
==============

1. app/celery_config.py - Celery configuration
2. app/tasks.py - Celery tasks for notifications
3. start_celery_worker.py - Worker startup script
4. CELERY_SETUP_GUIDE.txt - This file


FILES MODIFIED:
===============

1. app/routers/bookings.py:
   - Removed threading import
   - Added Celery task import
   - Changed to queue-based delivery
   - Added logging


NEXT STEPS:
===========

1. Start Redis: redis-server
2. Start Celery Worker: python start_celery_worker.py
3. Start API: python run.py
4. Test booking and payment flow
5. Watch worker process messages
6. Verify notifications arrive


MONITORING CHECKLIST:
=====================

Daily:
☐ Check worker is running
☐ Check queue size (should be near 0)
☐ Check error logs
☐ Verify notifications sending

Weekly:
☐ Review retry rates
☐ Check Redis memory usage
☐ Monitor worker performance
☐ Review failed task logs

Monthly:
☐ Optimize worker count
☐ Review Redis configuration
☐ Update retry logic if needed
☐ Performance tuning


SUPPORT:
========

For issues:
1. Check worker logs
2. Check Redis status
3. Check API logs
4. Review this guide

For questions about:
- Celery: https://docs.celeryproject.org/
- Redis: https://redis.io/documentation
- Task monitoring: Use Flower (celery flower)
